#include <iostream>
using namespace std;

#include "AccessTable.h"

int main()
{
	setlocale(LC_ALL, "Russian");
    AccessTable accessTable(6, 5);
    string login;
    string operation;
    accessTable.printInfo();

	do {
		cout << "Введите логин: ";
		cin >> login;
    
		if ( accessTable.containsUser(login) ) {
			int userId = accessTable.getUserId(login);
			cout << "Отлично. Ваши права: " << endl;
			for (int obj = 0; obj < 5; ++obj) {
				string perm = accessTable.getPermissionString(userId, obj);
				cout << "Object " << obj + 1 << ": " << perm << endl;
			}
			do 
			{
				int obj;
				cout << "Введите операцию (read, write, grant): ";
				cin >> operation;
				if ( operation == "read" ) {
					cout << "Объект: ";
					cin >> obj;
					int k = accessTable.getPermissionId(userId, --obj);
					if ( k >= READ && k <= FULL_ACCESS )
						cout << "Отлично" << endl;
					else
						cout << "Доступ запрещён" << endl;
				} else if ( operation == "write" ) {
					cout << "Объект: ";
					cin >> obj;
					int k = accessTable.getPermissionId(userId, --obj);
					if ( k == WRITE || k == WRITE_GRANT || k == READ_WRITE || k == FULL_ACCESS) {
						cout << "Отлично" << endl;
					} else {
						cout << "Доступ запрещён" << endl;
					}
				} else if ( operation == "grant" ) {
					cout << "Объект: ";
					cin >> obj;
					int k = accessTable.getPermissionId(userId, --obj);
					if ( k == GRANT || k == WRITE_GRANT || k == READ_GRANT || k == FULL_ACCESS) {
						std::string user;
						std::string permission;
						cout << "Право: ";
						cin >> permission;
						int permissionId = accessTable.getPermissionId(permission);
                        if ( permissionId == GRANT) {
                            cout << "Нельзя." << endl;
                            continue;
                        }                
						cout << "Пользователь: ";
						cin >> user;
						int tmpUserId = accessTable.getUserId(user);
                        if ( accessTable.havePermission(userId, obj, permissionId) ) {
						    accessTable.setPermissionForUserObject(tmpUserId, obj, permissionId);
                        } else {
                            cout << "Нельзя передать право" << endl;
                            continue;
                        }
						cout << "Отлично" << endl << endl ;
                        accessTable.printInfo();
                        cout << endl;
					} else {
						cout << "Доступ запрещён" << endl;
					}
				} else if ( operation == "quit" ) {
					break;
				}
			} while (1);
		} 
	} while(1);

    return 1;
}